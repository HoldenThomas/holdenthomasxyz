<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="shortcut icon" href="pictures/favicon.ico" type="image/xicon" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <title>Server Stuff | Holden's Website</title>
  </head>
  <body>
    <header><div class="container">
        <div id="branding"><h1>Holden's Website</h1></div>
        <nav><ul><li><a href="index.html">Home</a></li><li><a href="about.html">About</a></li></ul></nav>
    </div></header>

    <h1>Server Stuff</h1>
    <main>
      <p>These all require a VPS running Debian and registrar for your domain name.</p>
      <p><a href="#WebsiteSection">Website</a> | <a href="#EmailSection">Email</a> | <a href="#SearxSection">Searx</a> | <a href="#xmppSection">XMPP Prosody</a> | <a href="#GitSection">Git</a></p>

      <h2 id="WebsiteSection">Hosting a Website</h2>
      <p>Set DNS host records pointing to A(IPv4) and AAA(IPv6) with [nothing], *, www. With the IPv4 and IPv6 of your server. Then ssh into your server and enter these commands.</p>
      <pre><code>apt update
apt upgrade
apt install nginx python3-certbot-nginx rsync</code></pre>
      <p>Edit the file <code>/etc/nginx/sites-available/[websiteName]</code> with this.</p>
      <pre><code>server {
        listen 80 ;
        listen [::]:80 ;
        server_name [websiteName.com] [www.websiteName.com] ;
        root /var/www/[websiteName] ;
        index index.html index.htm index.nginx-debian.html ;
        location / {
                try_files $uri $uri/ =404 ;
        }
}</code></pre>
      <p>Then make a new directory <code>/var/www/[websiteName]</code> and edit a file called index.html in that directory with html for your homepage. Then enter these commands.</p>
      <pre><code>ln -s /etc/nginx/sites-available/[mywebsite] /etc/nginx/sites-enabled
systemctl reload nginx
certbot --nginx
crontab -e</code></pre>
      <p>Enter this after the last command in the file that opens.</p>
      <pre><code>0 0 1 * * certbot --nginx renew</code></pre>
      <h3>SSH config</h3>
      <p>Now on your actual computer enter these commands</p>
      <pre><code>ssh-keygen
ssh-copy-id root@[yourdomain.com]</code></pre>
      <p>Back on your server edit the file <code>/etc/ssh/sshd_config</code> with this</p>
      <pre><code>PasswordAuthentication no
ChallengeResponseAuthentication no
UsePAM no</code></pre>
      <P>Then enter this command.</P>
      <pre><code>systemctl reload sshd</code></pre>
      <h3>Setting up iptables with ufw</h3>
      <pre><code>ufw status
ufw default deny incoming # block all incoming connections by default
ufw allow in ssh # or: ufw allow in 22
ufw enable
ufw status verbose
ufw allow in 'WWW Full' # for websites
# for email
ufw allow in IMAPS
ufw allow in POP3
ufw allow in SMTP
ufw allow in 'Postfix SMTPS'
ufw allow in 'Mail Submission'
# for xmpp Prosody
ufw allow in 5222
ufw allow in 5269
ufw allow in 5000
ufw allow in 5280
ufw allow in 5281
# for git clone public
ufw allow in 9418
ufw reload
      </code></pre>
      <h2 id="EmailSection">Hosting a Email server</h2>
      <p>Set MX record priority 10 points to mail.[mydomain]. Set reverse DNS on vps with [IPv6] and [mydomain]. Go through same step to create a website for mail.[mywebsite]. Then enter these commands and enter internet site when asked and enter your domain name when asked.</p>
      <pre><code>curl -LO lukesmith.xyz/emailwiz.sh
sh emailwiz.sh</code></pre>
      <p>Add TXT records for @, _dmarc, mail._domainkey that come up after running the script in your registrar. Then enter these commands to create an account.</p>
      <pre><code>useradd -G mail -m [username]
passwd [username]</code></pre>
      <pre>Settings for loggin in to clients
	IMAP			SMTP
server	mail.[mydomain].[com]	mail.[mydomain].[com]
Port	993			587
SSL	SSL/TLS			STARTTLS</pre>
      <h2 id="SearxSection">Hosting a Search Engine with Searx</h2>
      <pre><code>git clone https://github.com/searx/searx
cd searx
sudo -H ./utils/searx.sh install all
sudo -H ./utils/filtron.sh install all
sudo -H ./utils/morty.sh install all
sudo -H ./utils/filtron.sh nginx install
sudo -H ./utils/morty.sh nginx install</code></pre>
      <p>Add and edit the file <code>/etc/nginx/sites-available/searx</code></p>
      <pre><code># https://example.org/searx
location /searx {
    proxy_pass         http://127.0.0.1:4004/;

    proxy_set_header   Host             $host;
    proxy_set_header   Connection       $http_connection;
    proxy_set_header   X-Real-IP        $remote_addr;
    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header   X-Scheme         $scheme;
    proxy_set_header   X-Script-Name    /searx;
}

location /searx/static/ {
    alias /usr/local/searx/searx-src/searx/static/;
}
# https://example.org/morty
location /morty {
    proxy_pass         http://127.0.0.1:3000/;

    proxy_set_header   Host             $host;
    proxy_set_header   Connection       $http_connection;
    proxy_set_header   X-Real-IP        $remote_addr;
    proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
    proxy_set_header   X-Scheme         $scheme;
}</code></pre>
      <pre><code>sudo -H ln -s /etc/nginx/sites-available/searx /etc/nginx/sites-enabled/searx</code></pre>
      <p>Edit <code>searx/settings.yml</code></p>
      <pre><code>result_proxy:
    # replace example.org with your server's public name
    url : https://example.org/morty
    key : !!binary "insert_your_morty_proxy_key_here"

server:
    image_proxy : True</code></pre>
      <pre><code>sudo -H systemctl restart nginx
sudo -H service uwsgi restart searx</code></pre>
      <h2 id="xmppSection">Hosting a XMPP Prosody Server</h2>
      <p>Add CNAME record [chat].[mywebsite].[com], www.[chat].[mywebsite].[com] or DNS host records pointing to server ip. Also for multi-user chat add another CNAME record for another subdomain [conference].[mywebsite].[com]. CNAME records on epik need trailing ".". Go through same steps on setting up a website.</p>
      <pre><code>apt install prosody prosody-modules hg
hg clone https://hg.prosody.im/prosody-modules/ /usr/lib/prosody/prosody-modules
hg pull --update # to update modules
prosodyctl --root cert import /etc/letsencrypt/live/
crotab -e
... certbot --nginx renew --post-hook "prosodyctl --root cert import /etc/letsencrypt/live/"</code></pre>
      <p>Edit the file <code>/etc/prosody/prosody.cfg.lua</code></p>
      <pre><code>plugin_paths = { "/usr/lib/prosody/modules", "/usr/lib/prosody/prosody-modules" }
admins = { "chad@example.org", "chadmin@example.org" }
modules_enabled = {

[...]

 -- For iOS push notification...
 "cloud_notify"; -- Support for XEP-0357 Push Notifications
 "mam";

  -- For file transfer
  "http_files"
  "proxy65"
}
-- For iOS push notification...
-- mod_cloud_notify settings
push_notification_with_body = false;
push_notification_with_sender = true;
VirtualHost "[chat].[mywebsite].[com]"
--For file transfer
Component "uploads.[mywebsite].[com]" "http_upload"
Component "proxy.[mywebsite].[com]" "proxy65"
http_upload_file_size_limit = 20971520
http_upload_expire_after = 60 * 60 * 24 * 7
---Set up a MUC (multi-user chat) room server on conference.example.com:
Component "[conference].[mywebsite].[com]" "muc"
restrict_room_creation = "admin"
room_default_public = false
muc_room_default_members_only = true
--- Store MUC messages in an archive and allow users to access it
-- For IOS push Notification...
modules_enabled = { "muc_mam"; "muc_cloud_notify"; }</code></pre>
      <pre><code>prosodyctl adduser [user]@[chat].[mywebsite].[com]
systemctl restart prosody</code></pre>
      <pre><code>ls -l /var/lib/prosody/*/accounts/*</code></pre>
      <h2 id="GitSection">Hosting Git Repositories</h2>
      <p>Add CNAME record [git].[mywebsite].[com], www.[git].[mywebsite].[com] CNAME records on epik need trailing ".". Go through same steps on setting up a website and add ssh key for git user after its created</p>
      <pre><code>sudo adduser git
sudo su git
mkdir /var/www/git
sudo chown --recursive git:git /var/www/git
mkdir /var/www/git/[project].git
cd /var/www/git/[project].git
git init --bare</code></pre>
      <p>On your actual computer enter these commands.</p>
      <pre><code>cd myproject
git init
git add .
git commit -m 'Initial commit'
git remote add origin git@gitserver:/var/www/project.git
git push origin master</code></pre>
      <p>To make your git repository publicly cloneable make and edit the following file <code>/etc/systemd/system/git-daemon.service</code></p>
      <pre><code>[Unit]
Description=Start Git Daemon

[Service]
ExecStart=/usr/bin/git daemon --reuseaddr --base-path=/var/www/git/ /var/www/git

Restart=always
RestartSec=500ms

StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=git-daemon

User=git
Group=git

[Install]
WantedBy=multi-user.target</code></pre>
      <p>Now enter the following commands.</p>
      <pre><code>systemctl enable git-daemon --now
touch /var/www/git/[project].git/git-daemon-export-ok</code></pre>
      <p>Now the front end for are git server can be set up with stagit.</p>
      <pre><code>ssh git@[mywebsite].[com]
cd /var/www/git
git clone git://git.codemadness.org/stagit /var/www/git/
cp stagit/logo.png ..</code></pre>
      <p>Either make your own css file for your website or copy the one from stagit into your website directory. Then add and edit the file <code>/var/www/git/[project].git/hooks/post-receive</code></p>
      <pre><code>#!/bin/sh
# generic git post-receive hook.
# change the config options below and call this script in your post-receive
# hook or symlink it.
#
# usage: $0 [name]
#
# if name is not set the basename of the current directory is used,
# this is the directory of the repo when called from the post-receive script.

# NOTE: needs to be set for correct locale (expects UTF-8) otherwise the
#       default is LC_CTYPE="POSIX".
export LC_CTYPE="en_US.UTF-8"

name="$1"
if test "${name}" = ""; then
                name=$(basename "$(pwd)")
                fi

# config
# paths must be absolute.
reposdir="/var/www/git"
dir="${reposdir}/${name}"
htmldir="/var/www/git"
stagitdir=""
destdir="${htmldir}${stagitdir}"
cachefile=".htmlcache"
# /config

if ! test -d "${dir}"; then
                echo "${dir} does not exist" >&2
                        exit 1
                        fi
                        cd "${dir}" || exit 1

# detect git push -f
force=0
while read -r old new ref; do
                test "${old}" = "0000000000000000000000000000000000000000" && continue
                        test "${new}" = "0000000000000000000000000000000000000000" && continue

                                hasrevs=$(git rev-list "${old}" "^${new}" | sed 1q)
                                        if test -n "${hasrevs}"; then
                                                                force=1
                                                                                break
                                                                                        fi
                                                                                        done

# strip .git suffix.
r=$(basename "${name}")
d=$(basename "${name}" ".git")
printf "[%s] stagit HTML pages... " "${d}"

mkdir -p "${destdir}/${d}"
cd "${destdir}/${d}" || exit 1

# remove commits and ${cachefile} on git push -f, this recreated later on.
if test "${force}" = "1"; then
                rm -f "${cachefile}"
                        rm -rf "commit"
                        fi

# make index.
stagit-index "${reposdir}/"*.git/ > "${destdir}/index.html"

# make pages.
stagit -c "${cachefile}" -u "https://git.holdenthomas.xyz/$d/" "${reposdir}/${r}"

ln -sf log.html index.html
ln -sf ../style.css style.css
ln -sf ../logo.png logo.png

echo "done"</code></pre>
      <p>This will allow for stagit to update every time you push to a repository.</p>
      <p>If you want a raw file for something like curl alos add this to the same file.</p>
      <pre><code>git clone "${dir}" "${destdir}/${d}/tmp"
mv "${destdir}/${d}/tmp/[fileName]" "${destdir}/${d}"
rm -rf "${destdir}/${d}/tmp"</code></pre>
      <pre><code>chmod +x /var/www/git/[project].git/hooks/post-receive
mkdir [repoHTMLFolder] && cd [repoHTMLFolder]
echo "git://git.[mywebsite].[com]/[project] > /var/www/git/[project].git/url
stagit path/to/gitrepo
cd /var/www/git
stagit-index *.git > index.html
ln -s /var/www/git/logo.png /var/www/git/[repoHTMLFolder]
ln -s /var/www/git/style.css /var/www/git/[repoHTMLFolder]</code></pre>
    </main>

    <footer><a href="index.html">Home</a></footer>
  </body>
</html>
